name: Memory Safety

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  asan:
    name: AddressSanitizer
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Rust nightly
        uses: dtolnay/rust-action@nightly
        with:
          components: rust-src

      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-asan-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-asan-

      - name: Install LLVM tools
        run: |
          sudo apt-get update
          sudo apt-get install -y llvm

      - name: Run ASAN tests
        env:
          RUSTFLAGS: "-Z sanitizer=address"
          ASAN_OPTIONS: "detect_leaks=1:detect_stack_use_after_return=1"
        run: |
          cargo +nightly test --target x86_64-unknown-linux-gnu --workspace \
            -- --test-threads=1

  tsan:
    name: ThreadSanitizer
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Rust nightly
        uses: dtolnay/rust-action@nightly
        with:
          components: rust-src

      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-tsan-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-tsan-

      - name: Run TSAN tests
        env:
          RUSTFLAGS: "-Z sanitizer=thread"
          TSAN_OPTIONS: "second_deadlock_stack=1"
        run: |
          cargo +nightly test --target x86_64-unknown-linux-gnu --workspace \
            -- --test-threads=1

  miri:
    name: Miri (Undefined Behavior)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Rust nightly with Miri
        uses: dtolnay/rust-action@nightly
        with:
          components: miri, rust-src

      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-miri-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-miri-

      - name: Setup Miri
        run: cargo +nightly miri setup

      - name: Run Miri tests
        env:
          MIRIFLAGS: "-Zmiri-disable-isolation -Zmiri-symbolic-alignment-check"
        run: |
          # Run Miri on crates without FFI dependencies
          cargo +nightly miri test --workspace \
            --exclude "*-ffi*" \
            -- --test-threads=1 || true

  leak-check:
    name: Memory Leak Detection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust nightly
        uses: dtolnay/rust-action@nightly
        with:
          components: rust-src

      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-leak-${{ hashFiles('**/Cargo.lock') }}

      - name: Install valgrind
        run: sudo apt-get update && sudo apt-get install -y valgrind

      - name: Run leak check on integration tests
        run: |
          cargo build --workspace --tests
          # Find and run test binaries through valgrind
          for test_bin in target/debug/deps/creto_*-*; do
            if [ -x "$test_bin" ] && [[ "$test_bin" != *.d ]]; then
              echo "Checking $test_bin for leaks..."
              valgrind --leak-check=full --error-exitcode=1 \
                --suppressions=/dev/null \
                "$test_bin" --test-threads=1 2>&1 | head -100 || true
            fi
          done

  sanitizers-complete:
    name: Memory Safety Complete
    runs-on: ubuntu-latest
    needs: [asan, tsan, miri, leak-check]
    if: always()
    steps:
      - name: Check sanitizer results
        run: |
          if [[ "${{ needs.asan.result }}" == "failure" ]]; then
            echo "❌ ASAN detected memory issues"
            exit 1
          fi
          if [[ "${{ needs.tsan.result }}" == "failure" ]]; then
            echo "❌ TSAN detected data races"
            exit 1
          fi
          if [[ "${{ needs.miri.result }}" == "failure" ]]; then
            echo "❌ Miri detected undefined behavior"
            exit 1
          fi
          echo "✅ All memory safety checks passed"
