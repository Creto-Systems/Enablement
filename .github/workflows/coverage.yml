name: Coverage

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run coverage checks daily at 2 AM UTC
    - cron: "0 2 * * *"
  workflow_dispatch:

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always
  # Packages requiring higher coverage (security-critical)
  HIGH_COVERAGE_PACKAGES: "creto-common"
  COVERAGE_THRESHOLD: 80

jobs:
  coverage:
    name: Coverage Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: llvm-tools-preview

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-coverage-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-coverage-

      - name: Install cargo-llvm-cov
        run: cargo install cargo-llvm-cov --locked

      - name: Run coverage for creto-metering
        run: |
          mkdir -p coverage
          cargo llvm-cov --package creto-metering \
            --lcov --output-path coverage/metering.lcov \
            --ignore-filename-regex="tests/.*" || {
            echo "::warning::Coverage measurement failed for creto-metering"
          }

      - name: Run coverage for creto-oversight
        run: |
          cargo llvm-cov --package creto-oversight \
            --lcov --output-path coverage/oversight.lcov \
            --ignore-filename-regex="tests/.*" || {
            echo "::warning::Coverage measurement failed for creto-oversight"
          }

      - name: Run coverage for creto-common
        run: |
          cargo llvm-cov --package creto-common \
            --lcov --output-path coverage/common.lcov \
            --ignore-filename-regex="tests/.*" || {
            echo "::warning::Coverage measurement failed for creto-common"
          }

      - name: Run workspace coverage
        run: |
          cargo llvm-cov --workspace \
            --lcov --output-path coverage/workspace.lcov \
            --ignore-filename-regex="tests/.*" || {
            echo "::warning::Workspace coverage measurement failed"
          }

      - name: Check coverage thresholds
        run: |
          echo "=== Coverage Threshold Check ==="

          check_coverage() {
            local file=$1
            local threshold=$2
            local name=$3

            if [ -f "$file" ]; then
              local lines_found=$(grep -c "^DA:" "$file" 2>/dev/null || echo "0")
              local lines_hit=$(grep "^DA:" "$file" 2>/dev/null | grep -cv ",0$" || echo "0")

              if [ "$lines_found" -gt 0 ]; then
                local coverage=$(awk "BEGIN {printf \"%.1f\", ($lines_hit/$lines_found)*100}")
                echo "$name: $coverage% ($lines_hit/$lines_found lines)"

                # Check threshold
                if [ "$(echo "$coverage < $threshold" | bc -l)" -eq 1 ]; then
                  echo "::error::$name coverage ($coverage%) below threshold ($threshold%)"
                  return 1
                else
                  echo "::notice::$name coverage meets threshold âœ“"
                fi
              else
                echo "::warning::No coverage data found for $name"
              fi
            else
              echo "::warning::Coverage file not found: $file"
            fi
            return 0
          }

          FAILED=0

          # Check individual package coverage (80% threshold)
          check_coverage "coverage/metering.lcov" ${{ env.COVERAGE_THRESHOLD }} "creto-metering" || FAILED=1
          check_coverage "coverage/oversight.lcov" ${{ env.COVERAGE_THRESHOLD }} "creto-oversight" || FAILED=1
          check_coverage "coverage/common.lcov" 85 "creto-common" || FAILED=1

          if [ $FAILED -eq 1 ]; then
            echo "::error::Some packages do not meet coverage thresholds"
            exit 1
          fi

          echo "::notice::All coverage thresholds met âœ“"

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/*.lcov
          flags: unittests
          name: codecov-enablement
          fail_ci_if_error: false
          verbose: true

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: coverage/
          retention-days: 30

      - name: Comment PR with coverage report
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            let summary = '## ðŸ“Š Coverage Report\n\n';
            summary += '| Package | Status |\n';
            summary += '|---------|--------|\n';

            const packages = ['metering', 'oversight', 'common'];
            for (const pkg of packages) {
              const file = `coverage/${pkg}.lcov`;
              if (fs.existsSync(file)) {
                summary += `| creto-${pkg} | âœ… Coverage collected |\n`;
              } else {
                summary += `| creto-${pkg} | âš ï¸ No coverage data |\n`;
              }
            }

            summary += '\n---\n';
            summary += '*Coverage threshold: 80% (85% for creto-common)*\n';
            summary += '*Generated with cargo-llvm-cov*\n';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
